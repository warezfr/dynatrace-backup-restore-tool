<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynatrace Backup Manager - Web UI</title>
  <link rel="stylesheet" href="/static/css/webmin.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">Dynatrace Backup Manager</div>
    <ul>
      <li class="active">Environments</li>
      <li>Groups</li>
      <li>Bulk Operations</li>
      <li>Backups</li>
    </ul>
  </div>
  <div class="main">
    <div class="header">
      <div>
        <h1>Environments</h1>
        <p>Multi-tenant (Managed & SaaS)</p>
      </div>
      <div>
        <button id="refreshBtn" class="btn">⟳ Refresh</button>
        <button id="newEnvBtn" class="btn primary">➕ New Environment</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Environments</div>
      <table id="envTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Deployment</th>
            <th>URL</th>
            <th>Status</th>
            <th>Last Tested</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-title">Groups</div>
      <div class="card-actions">
        <button id="newGroupBtn" class="btn">➕ New Group</button>
      </div>
      <table id="groupTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Members</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle">New Environment</h2>
      <form id="envForm">
        <label>Name <input name="name" required></label>
        <label>Environment Type
          <select name="env_type">
            <option value="production">Production</option>
            <option value="staging">Staging</option>
            <option value="development">Development</option>
            <option value="testing">Testing</option>
            <option value="training">Training</option>
            <option value="custom">Custom</option>
          </select>
        </label>
        <label>Deployment Type
          <select name="deployment_type">
            <option value="managed">Managed</option>
            <option value="saas">SaaS</option>
          </select>
        </label>
        <label>Environment URL
          <input name="environment_url" placeholder="https://dynatrace.example.com/e/12345678" required>
        </label>
        <label>API Token
          <input name="api_token" type="password" required>
        </label>
        <label>Tags (comma-separated)
          <input name="tags" placeholder="team-a, critical">
        </label>
        <label><input type="checkbox" name="insecure_ssl"> Allow insecure SSL</label>
        <div class="hint">Scopes: Managed → config.read, config.write. SaaS → add API v2 scopes (e.g., settings:objects:read).</div>
        <div class="modal-actions">
          <button type="button" id="cancelModal" class="btn">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = "/api";

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const envForm = document.getElementById("envForm");
    const refreshBtn = document.getElementById("refreshBtn");
    const newEnvBtn = document.getElementById("newEnvBtn");
    const newGroupBtn = document.getElementById("newGroupBtn");
    const cancelModal = document.getElementById("cancelModal");

    let currentEditId = null;

    function showModal(title, data) {
      modalTitle.textContent = title;
      modal.classList.remove("hidden");
      envForm.reset();
      currentEditId = data?.id || null;
      if (data) {
        envForm.name.value = data.name || "";
        envForm.env_type.value = data.env_type || "production";
        envForm.deployment_type.value = data.deployment_type || "managed";
        envForm.environment_url.value = data.environment_url || "";
        envForm.api_token.value = data.api_token || "";
        envForm.tags.value = (data.tags || []).join(", ");
        envForm.insecure_ssl.checked = !!data.insecure_ssl;
      }
    }

    function hideModal() {
      modal.classList.add("hidden");
    }

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, options);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return res.json();
    }

    function renderEnvs(envs) {
      const tbody = document.querySelector("#envTable tbody");
      tbody.innerHTML = "";
      envs.forEach(env => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${env.name}</td>
          <td>${env.env_type}</td>
          <td>${env.deployment_type || "managed"}</td>
          <td>${env.environment_url}</td>
          <td>${env.is_healthy ? "Healthy" : "Unknown"}</td>
          <td>${env.last_tested_at || "-"}</td>
        `;
        tr.onclick = () => showModal("Edit Environment", env);
        tbody.appendChild(tr);
      });
    }

    function renderGroups(groups) {
      const tbody = document.querySelector("#groupTable tbody");
      tbody.innerHTML = "";
      groups.forEach(g => {
        const members = (g.environment_ids || []).length;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${g.name}</td>
          <td>${g.description || ""}</td>
          <td>${members} member(s)</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function refreshData() {
      try {
        const envs = await fetchJson(`${apiBase}/environments/`);
        renderEnvs(envs);
      } catch (err) {
        alert("Failed to fetch environments: " + err);
      }
      try {
        const groups = await fetchJson(`${apiBase}/environments/groups/`);
        renderGroups(groups);
      } catch (err) {
        console.warn("Groups fetch failed", err);
      }
    }

    envForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        name: envForm.name.value.trim(),
        env_type: envForm.env_type.value,
        deployment_type: envForm.deployment_type.value,
        environment_url: envForm.environment_url.value.trim(),
        api_token: envForm.api_token.value.trim(),
        tags: envForm.tags.value.split(",").map(t => t.trim()).filter(Boolean),
        insecure_ssl: envForm.insecure_ssl.checked,
        description: null
      };
      const url = currentEditId ? `${apiBase}/environments/${currentEditId}` : `${apiBase}/environments`;
      const method = currentEditId ? "PUT" : "POST";
      try {
        await fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        hideModal();
        refreshData();
      } catch (err) {
        alert("Save failed: " + err);
      }
    });

    refreshBtn.onclick = refreshData;
    newEnvBtn.onclick = () => showModal("New Environment");
    newGroupBtn.onclick = () => alert("Group creation via API not wired in this page yet.");
    cancelModal.onclick = hideModal;
    modal.onclick = (e) => { if (e.target === modal) hideModal(); };

    refreshData();
  </script>
</body>
</html>
